# Stage 1: Build Angular frontend
FROM node:lts-alpine AS frontend-build

WORKDIR /mean-app

# Set Husky environment variable BEFORE installing dependencies
ENV HUSKY=0
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

COPY . .
RUN yarn build --prod

# Stage 2: Build Node.js backend
FROM node:alpine

WORKDIR /mean-app

# Set Husky environment variable BEFORE copying package files and installing
ENV HUSKY=0
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile --production

COPY . .

COPY --from=frontend-build /mean-app/dist ./dist

EXPOSE 3000

CMD ["node", "server.js"]